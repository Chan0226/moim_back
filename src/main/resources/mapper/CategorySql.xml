<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="data.mapper.CategoryMapper">

    <!--  메인페이지 카테고리 목록 출력  -->
    <select id="getAllCategory" resultType="CategoryDto">
        select *
        from category
    </select>

    <!-- 카테고리에 해당하는 방들 출력   -->
    <select id="getCategoryRoom" parameterType="Map" resultType="RoomDto">
        SELECT *
        FROM room
        WHERE name like CONCAT('%',#{name},'%')
              and headcount >= #{headCount}
              and address like CONCAT('%',#{address},'%')
              and payment like CONCAT('%',#{payment},'%')
              and weekAmprice between #{sprice} and #{eprice}
              and num IN (<include refid="facility"/>)
#                   SELECT roomNum FROM roomCategory WHERE categoryNum = #{num})
              order by ${sort};
    </select>
    <!-- weekAmprice, facility, payment-->
    <sql id="union">
        <foreach collection="facilityList" item="item" separator="UNION ALL">
            SELECT roomNum FROM roomFacility where facilityNum=#{item}
        </foreach>
    </sql>

    <sql id="facility">
        with res as( <include refid="union"/>)
        -- count 개수는 list length
        SELECT roomNum FROM res GROUP BY roomNum HAVING COUNT(*)=#{facilityLength};
    </sql>


    <!-- 번호에 해당하는 카테고리 출력  -->
    <select id="selectCategory" parameterType="int" resultType="CategoryDto">
        select * from category where num=#{categoryNum}
    </select>

    <insert id="insertCategory" parameterType="RoomCategoryDto">
        insert into roomCategory (roomNum, categoryNum)
        values (#{roomNum}, #{categoryNum})
    </insert>

</mapper>